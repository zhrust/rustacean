<!DOCTYPE HTML>
<html lang="zh" class="sidebar-visible no-js light">

<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>🌝 BXMr - be Rustaceans</title>


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="如何成为一名合格的 Rustacean ? 肯定有个过程, 这儿记录了私人这个转化过程...">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff" />

    <link rel="icon" href="../favicon.svg">
    <link rel="shortcut icon" href="../favicon.png">
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/general.css">
    <link rel="stylesheet" href="../css/chrome.css">

    <!-- Fonts -->
    <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
    <link rel="stylesheet" href="../fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="../highlight.css">
    <link rel="stylesheet" href="../tomorrow-night.css">
    <link rel="stylesheet" href="../ayu-highlight.css">

    <!-- Custom theme stylesheets -->
    <link rel="stylesheet" href="../theme/style.css">


</head>

<body>
    <!-- Provide site root to javascript -->
    <script type="text/javascript">
        var path_to_root = "../";
        var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
    </script>

    <!-- Work around some values being stored in localStorage wrapped in quotes -->
    <script type="text/javascript">
        try {
            var theme = localStorage.getItem('mdbook-theme');
            var sidebar = localStorage.getItem('mdbook-sidebar');
            if (theme.startsWith('"') && theme.endsWith('"')) {
                localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
            }
            if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
            }
        } catch (e) { }
    </script>

    <!-- Set the theme before any content is loaded, prevents flash -->
    <script type="text/javascript">
        var theme;
        try { theme = localStorage.getItem('mdbook-theme'); } catch (e) { }
        if (theme === null || theme === undefined) { theme = default_theme; }
        var html = document.querySelector('html');
        html.classList.remove('no-js')
        html.classList.remove('light')
        html.classList.add(theme);
        html.classList.add('js');
    </script>

    <!-- Hide / unhide sidebar before it is displayed -->
    <script type="text/javascript">
        var html = document.querySelector('html');
        var sidebar = 'hidden';
        if (document.body.clientWidth >= 1080) {
            try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch (e) { }
            sidebar = sidebar || 'visible';
        }
        html.classList.remove('sidebar-visible');
        html.classList.add("sidebar-" + sidebar);
    </script>

    <nav id="sidebar" class="sidebar" aria-label="Table of contents">
        <div class="sidebar-scrollbox">
            <ol class="chapter"><li class="chapter-item expanded "><a href="../abt/index.html">成为 Rustacean</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../abt/gh-pages.html">gh-pages</a></li><li class="chapter-item "><a href="../abt/zhrust.html">zhrust</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">自学练习</li><li class="spacer"></li><li class="chapter-item expanded "><a href="../101/index.html">Rust 学习</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../101/chatgpt101.html">伴学ChatGPT</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../101/chat_dyn101.html">dyn 初步</a></li></ol></li><li class="chapter-item "><a href="../101/idioms.html">idioms</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../101/idiom325_create_a_queue.html">idiom#325:构造队列</a></li></ol></li><li class="chapter-item "><a href="../101/quiz.html">Quiz.rs</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../101/quiz_1.html">Quiz#1</a></li></ol></li><li class="chapter-item "><a href="../101/exercism.html">Exercism</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../101/ex42all-your-base.html">42:all-your-base</a></li><li class="chapter-item "><a href="../101/ex43Allergies.html">43:Allergies</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">实践🌚🌘🌗🌖🌝</li><li class="spacer"></li><li class="chapter-item expanded "><a href="../dev/index.html">Rust 开发</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/dama-projects.html">小作品</a></li><li class="chapter-item expanded "><a href="../dev/tui4cli.html">TUI</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/cli_nnera.html">🌖 NNera</a></li><li class="chapter-item "><a href="../dev/cli_ferris_art.html">🌝 Ferris艺术</a></li><li class="chapter-item expanded "><a href="../dev/cli_bxmr.html" class="active">🌝 BXMr</a></li><li class="chapter-item "><a href="../dev/cli_rss4mdbook.html">🌝 RSS4mdbook</a></li><li class="chapter-item "><a href="../dev/cli_yuzu.html">🌚 Yuzu</a></li></ol></li><li class="chapter-item "><a href="../dev/web4async.html">异步</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/tokio.html">Tokio</a></li><li class="chapter-item "><a href="../dev/graphql.html">GraphQL</a></li></ol></li><li class="chapter-item "><div>TTD</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/rust-unit-test-everything-wanted-know.html">Rust 单元测试得知道的一切</a></li><li class="chapter-item "><a href="../dev/debug_rust_with_codelldb.html">CodeLLDB</a></li></ol></li><li class="chapter-item "><a href="../dev/gui4web.html">GUI</a></li><li class="chapter-item "><a href="../dev/embedded_rs.html">嵌入</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/emb_rp2040pico.html">Pico</a></li></ol></li><li class="chapter-item "><div>CI/CD</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/cross-compiling.html">交叉编译?</a></li></ol></li><li class="chapter-item "><a href="../dev/20-things-ive-learned-in-my-20-years-as-a-software-engineer.html">20年来作为软件工程师学到的10件事</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/concepts-i-wish-i-learned-earlier.html">希望一早知道的关键概念</a></li></ol></li><li class="chapter-item "><div>实用工具推荐...</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/cli_btm.html">Bottom</a></li></ol></li></ol></li><li class="chapter-item expanded "><li class="part-title">工程经验</li><li class="spacer"></li><li class="chapter-item expanded "><a href="../tip/index.html">Rust 技能</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../tip/awesome4rs.html">Awesome.rs</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../tip/aw4rs_handlebars.html">Handlebars</a></li><li class="chapter-item "><a href="../tip/tracing.html">tracing 初步</a></li><li class="chapter-item "><a href="../tip/open_big_file_speed.html">文件加速打开</a></li></ol></li><li class="chapter-item "><a href="../tip/rust_min_bug_patterns.html">BMP:最小bug模式</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../tip/manag_growing_proj_with_crates_modules.html">Crate中合理划分目录</a></li></ol></li><li class="chapter-item "><div>anti-OOP</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../tip/default-params.html">OOP:Rust 和默认参数</a></li><li class="chapter-item "><a href="../tip/oop-1-encapsulation.html">Rust 超越OOP,第1部分</a></li><li class="chapter-item "><a href="../tip/oop-2-polymorphism.html">Rust 超越OOP,第2部分</a></li></ol></li><li class="chapter-item "><a href="../tip/rust6fun-operator-overloading.html">运算符重载六件趣事</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">笔记嗯哼</li><li class="spacer"></li><li class="chapter-item expanded "><a href="../log/index.html">笔记</a><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../log/rust101logging.html">Rust 课程笔记</a></li><li class="chapter-item "><a href="../log/rust-s-ugly-syntax.html">Rust 丑句法</a></li><li class="chapter-item "><a href="../log/graph-rust-move-copy-borrow.html">图形描述 Rust 中所有权和借用</a></li><li class="chapter-item "><div>Choas嗯哼</div><a class="toggle"><div>❱</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../log/c101.html">0基础入门C?</a></li><li class="spacer"></li></ol></li></ol></li></ol>
        </div>
        <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
    </nav>

    <div id="page-wrapper" class="page-wrapper">

        <div class="page">
                        <div id="menu-bar-hover-placeholder"></div>
            <div id="menu-bar" class="menu-bar sticky bordered">
                <div class="left-buttons">
                    <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                        <i class="fa fa-bars"></i>
                    </button>
                    <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                        <i class="fa fa-paint-brush"></i>
                    </button>
                    <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                        <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button>
                        </li>
                    </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                        aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                        aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
                </div>

                <h1 class="menu-title">be Rustaceans</h1>

                <div class="right-buttons">
                    <a href="https://github.com/zhrust/rustacean/tree/main/src" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-github"></i>
                    </a>
                    <a href="https://github.com/zhrust/rustacean/blob/main/src/src/dev/cli_bxmr.md" title="Suggest an edit" aria-label="Suggest an edit">
                        <i id="git-edit-button" class="fa fa-edit"></i>
                    </a>

                    <a href="/rss.xml" title="RSS.xml" aria-label=""RSS.xml">
                        <b id="git-edit-button" class="fa fa-feed"></b>
                    </a>

                </div>
            </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..."
                        aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

            <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
            <script type="text/javascript">
                document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                    link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                });
            </script>

            <div id="content" class="content">
                <!-- Page table of contents -->
                <div class="sidetoc">
                    <nav class="pagetoc"></nav>
                </div>
                <main>
                    <h1 id="bxmr"><a class="header" href="#bxmr">BXMr</a></h1>
<blockquote>
<p>rIME-Squirrel 表形码维护工具</p>
</blockquote>
<h2 id="backgroung"><a class="header" href="#backgroung">backgroung</a></h2>
<p>作为一名程序猿, 总是要对输入法也要有全面控制</p>
<p>所以, 一直有折腾:<a href="https://github.com/ZoomQuiet/ZqBXM/tree/master/Rime-Squirrel">ZqBXM/Rime-Squirrel at master · ZoomQuiet/ZqBXM</a></p>
<h2 id="goal"><a class="header" href="#goal">goal</a></h2>
<p>全面使用 Rust 重构原有 Python 版本的维护指令集;</p>
<h2 id="trace"><a class="header" href="#trace">trace</a></h2>
<ul>
<li>最早是 手工维护</li>
<li>后来用 Python 写了个脚本, 但是还是要人工复制到对应目录中再重新编译码表</li>
<li>又后来, 使用 invoke 框架拓展并增强了 BXM 码表的维护内部编辑</li>
<li>现在, 轮到 Rust 来重构了...</li>
</ul>
<h3 id="feeling"><a class="header" href="#feeling">feeling</a></h3>
<blockquote>
<p>终于有感觉了...</p>
</blockquote>
<p>知道 Rust 有年头了, 但是, 和 golang 类似, 一直没有认真上手,
golang 也开发过几个实用小工具/系统, 感觉和用 Python 差不多,
还是得靠 print 以及线上人眼观察...</p>
<p>Rust 开始进入 Linux 内核了, 感觉不一样了, 足够敦实了,
而且, 以往好象所有折腾过的开发语言都是有 GC 的...</p>
<p>在完成 <a href="/dev/cli_ferris_art.html">Ferris艺术</a> 小工具后,
决定介入日常生活, 重制这个实用工具: <code>BXMr</code> ~ BXM 管理器;
以便替代原先 Python 版本的 -&gt; <a href="https://github.com/ZoomQuiet/ZqBXM/blob/master/Rime-Squirrel/tasks.py">tasks.py</a></p>
<p>代码的增长, 要求必须对项目目录结构进行良好的规划/控制/演变/...</p>
<p>进一步的, 在代码调试过程中, 发现, 有了 rust-analyzer 的加持,
以往的循环:</p>
<pre><code>    开发
    ^   \ 
    |    运行
    |     \
    |     观察 print()
    |    /
     调试
</code></pre>
<p>可以有质的提升, 现在可以完全信任编译器了,
现在的流程变成:</p>
<ul>
<li>思考问题</li>
<li>撰写代码, 实时根据 RA(rust-analyzer) 提示, 进行修订</li>
<li>那么嘦在 IDE 中没有警告时 
<ul>
<li>一般 cargo check 也不会有问题</li>
<li>以及 cargo check 也不会有问题</li>
<li>甚至 cargo build 也不会有问题</li>
<li>...也就意味着此时, 代码包含的所有应用/系统行为就已经是可信/可用/坚不可摧的了</li>
</ul>
</li>
<li>这种问题/目标/代码/理解/... all-in-one 的感觉太坚实了
<ul>
<li>对比以往其它语言, 即便是 IDE/编译器 都没问题</li>
<li>真正运行起来时, 照样有各种意外</li>
<li>...那种感觉就象 屎莱姆 ...软卟卟的,想怎么折腾就怎么折腾, 可就是永远固定不到一个理想的状态</li>
</ul>
</li>
<li>而 Rust 世界中,嘦编译器过了, 基本上就夯实了...</li>
<li>如果有问题, 基本上可以明确, 绝对不是代码问题
<ul>
<li>只可能是自己对问题的理解有偏差</li>
<li>以及代码表述的行为和我们的期待不同...</li>
</ul>
</li>
</ul>
<blockquote>
<p>工作量:</p>
</blockquote>
<pre><code>
༄  tokei
===============================================================================
 Language            Files        Lines         Code     Comments       Blanks
===============================================================================
 Markdown                2          218            0          152           66
 Rust                   13         1137          657          322          158
 TOML                    1           51           28           15            8
===============================================================================
 Total                  16         1406          685          489          232
===============================================================================
</code></pre>
<p>对比原有 Python 的版本:</p>
<pre><code>
༄  tokei tasks.py
===============================================================================
 Language            Files        Lines         Code     Comments       Blanks
===============================================================================
 Python                  1          248          157           22           69
===============================================================================
 Total                   1          248          157           22           69
===============================================================================
</code></pre>
<p>嗯哼? 没有主观感觉的10倍, 当然,过程中删除的不同版本,得有10倍了;</p>
<h3 id="verb"><a class="header" href="#verb">verb</a></h3>
<blockquote>
<p>纠结所在....</p>
</blockquote>
<p>原问题是这样的:</p>
<ul>
<li>输入法的码表, 只是就是一批 键码和文字 的 K/V 值对</li>
<li>在 rIME-Squirrel 中则是要求组织为一个约定的 .yaml 文件
<ul>
<li>数据结构为: &quot;{文字}\t{键码}&quot;</li>
<li>键码相同指向多个文字时, 就对应复制出新行来</li>
<li>行的前后顺序决定了输入时推荐的顺序</li>
<li>比如现有定义码表行片段:
<ul>
<li>敠    aaaa</li>
<li>叕    aaaa</li>
<li>敪    aaaa</li>
<li>娺    aaaa</li>
<li>啊啊啊啊    aaaa</li>
</ul>
</li>
<li>那么在使用 rIME 输入时自动弹出的推荐字列就应该是:</li>
</ul>
</li>
</ul>
<p><img src="https://ipic.zoomquiet.top/2023-03-05-zshot%202023-03-05%2021.16.04.jpg" alt="aaaa" /></p>
<p>难点在 <code>键/字</code> 条目行的次序是有要求的, 以后插入时要遵守:</p>
<ul>
<li>短键码在前</li>
<li>ASCII 字母顺序为先</li>
<li>长度从 1 到 4 个字符</li>
<li>不可能超过 4 个字符</li>
<li>例如:
<ul>
<li>a 在 b 之前</li>
<li>a 在 aa 之前</li>
<li>aa 在 ab 之前</li>
<li>az 在 aaa 之前</li>
<li>aaaa 在 b 之前</li>
<li>...</li>
</ul>
</li>
<li>如果对应键并没定制就不记录</li>
<li>例如:
<ul>
<li>原有定义条目记录:
<ul>
<li>btk 是不并</li>
<li>btmd 悬而未决</li>
</ul>
</li>
<li>那么, 想追加一个 <code>btl 是也乎</code> 就应该插入为:
<ul>
<li>btk 是不并</li>
<li>btl 是也乎</li>
<li>btmd 悬而未决</li>
</ul>
</li>
</ul>
</li>
<li>这里就问题就在一个原本有具体排序要求的键码序列
<ul>
<li>本身是残缺的</li>
<li>要判定某个新增键码应该在哪里插入,要顾虑的条件很多</li>
<li>以往都是人工观察插入的...还不得保证对, 那时 rIME 编译时就报错...</li>
</ul>
</li>
</ul>
<p>所以, Python 代码实现时, 用了一个反模式:</p>
<ul>
<li>先根据 BXM 的编码规则, 构造出一个严格按照键码排序的编码表</li>
<li>然后, 再根据现行使用的 BXM 定义 <code>键/字</code> 填写入这个编码表</li>
<li>那么, 进行维护时就变成一个简单的查表过程:
<ul>
<li>对原有 <code>键/字</code> 的条目, 追加同键不同字时, 追加字到对应的键后数组就好</li>
<li>对原先没有的条目, 到对应键后空白数组中追加就好</li>
<li>...</li>
<li>最后需要更新 .yaml 时,  从这个全码全序的编码表对其中有效的条目进行转换输出就好</li>
</ul>
</li>
<li>也就是说, 将原先 .yaml 中的 &quot;{文字}\t{键码}&quot; 定义记录条目文本
<ul>
<li>先变成 &quot;{&quot;键&quot;:[&quot;字0&quot;,&quot;字1&quot;,,]}&quot; 类字典/HashMap 记录</li>
<li>而且,其中的键是吻合 BXM 规则的全部顺序可能键码</li>
</ul>
</li>
</ul>
<p>对应原有 Python 代码:</p>
<pre><code class="language-python">BXMC = &quot;abcdefghijklmnopqrstuvwxyz&quot;

@task
def init2(c):
    print(f&quot;init from\n\t{ORIG};\nAIM-&gt;\t{AIMP}&quot;)
    print(f&quot;{AIMP} exists?\n\t&quot;,os.path.exists(f&quot;{AIMP}&quot;))
    _gbxm = {}

    def generate_strings(length, prefix=''):
        if length == 0:
            return
        for c in BXMC:
            key = prefix + c
            print(key)
            _gbxm[key] = []
            generate_strings(length-1, key)

    generate_strings(4)
    print(f&quot;gen. all BXM code as {len(_gbxm.keys())}&quot;)
    return None
</code></pre>
<p>对应 Rust 版本是:</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>//  定义在: src/inv/util.rs
pub const BXMC: &amp;str = &quot;abcdefghijklmnopqrstuvwxyz&quot;;
pub const MBCL: usize = 4; // code len.

pub fn generate_strings(length: usize, 
            prefix: String, 
            gbxm: &amp;mut BTreeMap&lt;String, Vec&lt;String&gt;&gt;
        ) {
        if length == 0 {
            return;
        }
        for c in BXMC.chars() {
            let key = prefix.clone() + &amp;c.to_string();
            gbxm.insert(key.clone(), Vec::new());
            generate_strings(length - 1, key, gbxm);
        }
    }

pub fn init2(codelen:usize) -&gt; Option&lt;BTreeMap&lt;String, Vec&lt;String&gt;&gt;&gt; {
    let mut gbxm = BTreeMap::new();
    generate_strings(codelen, String::new(), &amp;mut gbxm);
    //println!(&quot;\n\t gen. all BXM code as {} &quot;, gbxm.len());

    Some(gbxm)
}

//  具体调用形式:
use crate::inv::util;
...
    let gbxm = util::init2(util::MBCL).unwrap();
<span class="boring">}</span></code></pre></pre>
<p>基本上和 Python 代码 1:1 转换, 当然, 代码的可信度要高很多;</p>
<p>接下来才是问题:</p>
<ul>
<li>生成的全量键码有 475,254 个
<ul>
<li>用 toml 记录时, 有4Mb</li>
</ul>
</li>
<li>而对应 BXM 当前包含的所有键码仅 60,337 个
<ul>
<li>用 yaml 记录时, 只有 700Kb</li>
</ul>
</li>
<li>用 Python 加载/更新/回写/... IO 操作时,要3~4秒</li>
<li>而用 cargo run 进行试用时, 要10秒左右
<ul>
<li>好在 cargo build --release 之后的二进制执行文件运行时, 快到了 2~3 秒</li>
</ul>
</li>
<li>这样还是慢哪....
<ul>
<li>尝试用异步 crate 加速, 效果不明显</li>
<li>以字母表为基准切为26个文件? 太麻烦而且, 要在用户本地生成一组文件本身也是问题</li>
<li>上 SQLite 内存数据库? 相同的数据量想加载到内存中一样有耗时要等待</li>
<li>....</li>
</ul>
</li>
</ul>
<blockquote>
<p>还能怎么加速呢?</p>
</blockquote>
<ul>
<li>以现行有效 <code>键/字</code> 定义为准, 只管理不到7万行数据,比将近50万行肯定要快
<ul>
<li>但是, 这就得完成完备的插入次序判定算法</li>
<li>...当然也行, 只是没必要, 如果 BXMr 想兼容所有输入法的话, 就不能特化支持特定码表...</li>
</ul>
</li>
<li>回到问题源头:
<ul>
<li>数据文件大, 所以加载慢</li>
<li>而且没使用多核 CPU 来加速</li>
<li>...</li>
<li>也就是说, 值得折腾的是利用 Rust 的系统编程能力:
<ul>
<li>构造 <code>键/字</code> 全量码表的二进制文件形式, 大幅减少要加载的文件尺寸</li>
<li>动用异步/并发/并行/多线程/非阻塞/... 能力, 在数据加载以及处理上加速</li>
</ul>
</li>
<li>正好, 这也就能将以往看的资料中高级话题, 对应到具体问题需求上来了...</li>
</ul>
</li>
</ul>
<h3 id="env"><a class="header" href="#env">.env</a></h3>
<blockquote>
<p>如何可以缓存各种常用配置?</p>
</blockquote>
<p>和 Python 日常开发和部署使用不同, 以往:</p>
<ul>
<li>一般使用个 _settings.py 文件,作为一个全局变量桶, 收集各种在所有模块中都要用的关键配置和数据
<ul>
<li>反正一般 Python 小工具发行时, 并没有编译/打包的过程, 都是脚本和配置一起发布</li>
<li>嘦注意加载的目录关系, 就可以无视操作系统, 在 Python 运行时的帮助下加载到需要的配置</li>
</ul>
</li>
</ul>
<p>但是, 在尝试用相似的行为套在 Rust 工程中才囧rz...</p>
<ul>
<li>如果也是用 _stettings.rs 那么编译后, 位置就不知道了, 而且用户本地要现场配置的东西也不可能写回 _settings.rs 了</li>
<li>那么,使用一个外部的 .toml 配置文件呢? 进行 cargo build --release 后, 发行单一可执行二进制目标文件, 和对应内核系统配套的, 一般并没人拖一个 .toml 来到本地配置</li>
<li>尝试将客户的配置信息记录到环境变量中, 才发现, 想永远有效必须写对应 *rc 文件, 问题是现在 bash 如不是大一统, 还有其它流行 shell 版本, 对应的 *rc 文件格式和位置也是不可预见的...</li>
<li>要不, 嘦涉及到外部导入/导出的来源和发布目标文件, 要求每次指令用户自己通过附加参数给出来就好?
<ul>
<li>回想自己使用就过程, 每次无论什么指令, 都要跟上 1~2 个, 或是更多路径参数....败退...</li>
</ul>
</li>
<li>...突然想到还有个 <code>.env</code> 文件哪...算是应用系统的随身运行时环境变量,本身很简单可以视为简化版本的 .ini 文件</li>
<li>追查了一下果然有 <a href="https://crates.io/crates/dotenv/0.15.0">dotenv - crates.io: Rust Package Registry</a>
<ul>
<li>那么逻辑就简单了:</li>
<li>无论用哪个指令, 先检验固定的和执行文件同目录的 .env 文件</li>
<li>如果没有, 指引用户先用 <code>$ bxmr cfg ...</code> 指令来完成关键文件的指引</li>
<li>然后, 写入 .env 文件中, 并自动加载到环境变量里</li>
<li>这样, 嘦运行自己工具的发行版, 就可以从本身所在目录中加载到以往的关键配置, 用在具体指令响应过程中...</li>
</ul>
</li>
</ul>
<h3 id="async"><a class="header" href="#async">async</a></h3>
<blockquote>
<p>只是想加速一个文件的读取...</p>
</blockquote>
<p>-&gt; <a href="/tip/open_big_file_speed.html">文件加速打开</a></p>
<p>然后就发现,这事儿没那么简单, 整体上:</p>
<blockquote>
<p>需要明确的是，async函数在Rust中是一种特殊的函数类型，可以在其中使用await操作符等异步操作，而async函数的返回类型是一个实现了Future trait的类型，这个类型在编译时是不确定的，因为它表示一个异步计算的结果，需要等待执行完成才能得到具体的结果类型。因此，当你调用一个async函数时，你需要在一个async上下文中，例如在async函数中或者使用tokio等异步运行时库的Runtime来运行异步任务。</p>
</blockquote>
<p>所以, 原有的调用栈:</p>
<ul>
<li>src/main.rs -&gt; fn main() 
<ul>
<li>inv::run() -&gt; src/inv.rs 
<ul>
<li>seek::echo() -&gt; src/inv/seek.rs
<ul>
<li>util::toml2btmap() -&gt; src/inv/util.rs
<ul>
<li>file.read_to_string(&amp;mut contents).unwrap()
<ul>
<li>let mut file = File::open(tfile).unwrap()</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>发现可以用 tokio 实现异步操作, 并加速文件读取?
<ul>
<li>于是-&gt; 
<ul>
<li>use tokio::fs::File as TokioFile;</li>
<li>use tokio::io::BufReader as TokioBufReader;</li>
</ul>
</li>
<li>然后-&gt; 
<ul>
<li>let file = TokioFile::open(path).await?;</li>
<li>let reader = TokioBufReader::new(file);</li>
</ul>
</li>
<li>但是, 发现不行, await? 不能编译, 因为所在函数不是 async 的, 于是连锁反应</li>
<li>pub async fn async_read_lines().await &lt;- 以便被调用
<ul>
<li>pub async fn async_toml2btmap() &lt;- 以便被调用
<ul>
<li>util::async_toml2btmap().await &lt;- src/inv/util.rs
<ul>
<li>async fn seek::echo().await &lt;- src/inv/seek.rs
<ul>
<li>async fn run() &lt;- src/inv.rs 
<ul>
<li>inv::run().await &lt;- src/main.rs
<ul>
<li>async fn main()</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>如果不是 rust-analyzer 一路提醒, 真会蒙圈儿的...</p>
<h2 id="refer"><a class="header" href="#refer">refer.</a></h2>
<ul>
<li><a href="https://docs.rs/clap/latest/clap/_derive/_cookbook/git_derive/index.html">clap::_derive::_cookbook::git_derive - Rust</a>
<ul>
<li>简化官方示例,完成结构性探索</li>
</ul>
</li>
<li><a href="https://medium.com/javascript-in-plain-english/coding-wont-exist-in-5-years-this-is-why-6da748ba676c">Building a CLI from scratch with Clapv3 | by Ukpai Ugochi | Medium</a>
<ul>
<li>很囧的案例, 看起来很美却根本编译不过...</li>
</ul>
</li>
<li>尴尬了, 二进制发行版本的应用可没有那么简单的全局配置可以使用...
<ul>
<li><a href="https://www.thorsten-hans.com/working-with-environment-variables-in-rust/">Working with Environment Variables in Rust · Thorsten Hans' blog</a></li>
<li>...</li>
</ul>
</li>
<li>...</li>
</ul>
<h2 id="logging"><a class="header" href="#logging">logging</a></h2>
<ul>
<li>...</li>
<li>230301 ZQ ...🦀</li>
<li>230227 ZQ mod/clap/tracing/... 项目结构厘定</li>
<li>230225 ZQ re-re-re-init.</li>
</ul>
<pre><code>        _~^|∽~_
    \) /  ◴ ☉  \ \/
      '_   ⎵   _'
      / '--∽--' \

...act by ferris-actor v0.2.4 (built on 23.0303.201916)
</code></pre>

                    <div id="giscus-container"></div>
                </main>

                <nav class="nav-wrapper" aria-label="Page navigation">
                    <!-- Mobile navigation buttons -->
                    <a rel="prev" href="../dev/cli_ferris_art.html" class="mobile-nav-chapters previous"
                        title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../dev/cli_rss4mdbook.html" class="mobile-nav-chapters next"
                        title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>

                    <div style="clear: both"></div>
                </nav>
            </div>
        </div>

        <nav class="nav-wide-wrapper" aria-label="Page navigation">
            <a rel="prev" href="../dev/cli_ferris_art.html" class="nav-chapters previous" title="Previous chapter"
                aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>

            <a rel="next" href="../dev/cli_rss4mdbook.html" class="nav-chapters next" title="Next chapter"
                aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
        </nav>

    </div>



    <script type="text/javascript">
        window.playground_line_numbers = true;
    </script>

    <script type="text/javascript">
        window.playground_copyable = true;
    </script>

    <script src="../ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="../editor.js" type="text/javascript" charset="utf-8"></script>
    <script src="../mode-rust.js" type="text/javascript" charset="utf-8"></script>
    <script src="../theme-dawn.js" type="text/javascript" charset="utf-8"></script>
    <script src="../theme-tomorrow_night.js" type="text/javascript" charset="utf-8"></script>

    <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

    <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
    <script src="../book.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" charset="utf-8">
        var pagePath = "dev/cli_bxmr.md"
    </script>


    <!-- Custom JS scripts -->
    <script type="text/javascript" src="../assets/custom.js"></script>
    <script type="text/javascript" src="../assets/bigPicture.js"></script>

    <hr />

    <p style="text-align:center">

        <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="知识共享许可协议"
                style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a>
        本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a>进行许可;-)
<!--
][ <b>
    <a href="/rss.xml">RSS</a>
    </b>
-->

    </p>
    <hr />

    <script src="https://utteranc.es/client.js" repo="zhrust/comments" issue-term="pathname" label="✨💬✨"
        theme="github-light" crossorigin="anonymous" async>
        </script>

</body>

</html>