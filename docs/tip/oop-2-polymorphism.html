<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">

<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>Rust è¶…è¶ŠOOP,ç¬¬2éƒ¨åˆ† - be Rustaceans</title>


    <!-- Custom HTML head -->
    
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="å¦‚ä½•æˆä¸ºä¸€ååˆæ ¼çš„ Rustacean ? è‚¯å®šæœ‰ä¸ªè¿‡ç¨‹, è¿™å„¿è®°å½•äº†ç§äººè¿™ä¸ªè½¬åŒ–è¿‡ç¨‹...">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff" />

    <link rel="icon" href="../favicon.svg">
    <link rel="shortcut icon" href="../favicon.png">
    <link rel="stylesheet" href="../css/variables.css">
    <link rel="stylesheet" href="../css/general.css">
    <link rel="stylesheet" href="../css/chrome.css">
    <link rel="stylesheet" href="../css/print.css" media="print">

    <!-- Fonts -->
    <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
    <link rel="stylesheet" href="../fonts/fonts.css">

    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="../highlight.css">
    <link rel="stylesheet" href="../tomorrow-night.css">
    <link rel="stylesheet" href="../ayu-highlight.css">

    <!-- Custom theme stylesheets -->


</head>

<body>
    <!-- Provide site root to javascript -->
    <script type="text/javascript">
        var path_to_root = "../";
        var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
    </script>

    <!-- Work around some values being stored in localStorage wrapped in quotes -->
    <script type="text/javascript">
        try {
            var theme = localStorage.getItem('mdbook-theme');
            var sidebar = localStorage.getItem('mdbook-sidebar');
            if (theme.startsWith('"') && theme.endsWith('"')) {
                localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
            }
            if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
            }
        } catch (e) { }
    </script>

    <!-- Set the theme before any content is loaded, prevents flash -->
    <script type="text/javascript">
        var theme;
        try { theme = localStorage.getItem('mdbook-theme'); } catch (e) { }
        if (theme === null || theme === undefined) { theme = default_theme; }
        var html = document.querySelector('html');
        html.classList.remove('no-js')
        html.classList.remove('light')
        html.classList.add(theme);
        html.classList.add('js');
    </script>

    <!-- Hide / unhide sidebar before it is displayed -->
    <script type="text/javascript">
        var html = document.querySelector('html');
        var sidebar = 'hidden';
        if (document.body.clientWidth >= 1080) {
            try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch (e) { }
            sidebar = sidebar || 'visible';
        }
        html.classList.remove('sidebar-visible');
        html.classList.add("sidebar-" + sidebar);
    </script>

    <nav id="sidebar" class="sidebar" aria-label="Table of contents">
        <div class="sidebar-scrollbox">
            <ol class="chapter"><li class="chapter-item "><a href="../abt/index.html"><strong aria-hidden="true">1.</strong> æˆä¸º Rustacean</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../abt/gh-pages.html"><strong aria-hidden="true">1.1.</strong> gh-pages</a></li><li class="chapter-item "><a href="../abt/zhrust.html"><strong aria-hidden="true">1.2.</strong> zhrust</a></li><li class="spacer"></li></ol></li><li class="chapter-item "><a href="../101/index.html"><strong aria-hidden="true">2.</strong> Rust å­¦ä¹ </a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../101/tracing.html"><strong aria-hidden="true">2.1.</strong> tracing åˆæ­¥</a></li><li class="chapter-item "><a href="../101/chatgpt101.html"><strong aria-hidden="true">2.2.</strong> ä¼´å­¦ChatGPT</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../101/chat_dyn101.html"><strong aria-hidden="true">2.2.1.</strong> dyn åˆæ­¥</a></li></ol></li><li class="chapter-item "><a href="../101/exercism.html"><strong aria-hidden="true">2.3.</strong> Exercism</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../101/ex42all-your-base.html"><strong aria-hidden="true">2.3.1.</strong> 42:all-your-base</a></li><li class="chapter-item "><a href="../101/ex43Allergies.html"><strong aria-hidden="true">2.3.2.</strong> 43:Allergies</a></li></ol></li><li class="chapter-item "><a href="../101/idioms.html"><strong aria-hidden="true">2.4.</strong> idioms</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../101/idiom325_create_a_queue.html"><strong aria-hidden="true">2.4.1.</strong> idiom#325:æ„é€ é˜Ÿåˆ—</a></li><li class="spacer"></li></ol></li></ol></li><li class="chapter-item "><a href="../dev/index.html"><strong aria-hidden="true">3.</strong> Rust å¼€å‘</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dev/dama-projects.html"><strong aria-hidden="true">3.1.</strong> å°ä½œå“</a></li><li class="chapter-item "><a href="../dev/cross-compiling.html"><strong aria-hidden="true">3.2.</strong> äº¤å‰ç¼–è¯‘?</a></li><li class="chapter-item "><a href="../dev/rust-unit-test-everything-wanted-know.html"><strong aria-hidden="true">3.3.</strong> Rust å•å…ƒæµ‹è¯•å¾—çŸ¥é“çš„ä¸€åˆ‡</a></li><li class="chapter-item "><a href="../dev/20-things-ive-learned-in-my-20-years-as-a-software-engineer.html"><strong aria-hidden="true">3.4.</strong> 20å¹´æ¥ä½œä¸ºè½¯ä»¶å·¥ç¨‹å¸ˆå­¦åˆ°çš„10ä»¶äº‹</a></li><li class="chapter-item "><a href="../dev/concepts-i-wish-i-learned-earlier.html"><strong aria-hidden="true">3.5.</strong> å¸Œæœ›ä¸€æ—©çŸ¥é“çš„å…³é”®æ¦‚å¿µ</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="../tip/index.html"><strong aria-hidden="true">4.</strong> Rust æŠ€è‰º</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../tip/rust6fun-operator-overloading.html"><strong aria-hidden="true">4.1.</strong> è¿ç®—ç¬¦é‡è½½å…­ä»¶è¶£äº‹</a></li><li class="chapter-item "><a href="../tip/default-params.html"><strong aria-hidden="true">4.2.</strong> OOP:Rust å’Œé»˜è®¤å‚æ•°</a></li><li class="chapter-item "><a href="../tip/oop-1-encapsulation.html"><strong aria-hidden="true">4.3.</strong> Rust è¶…è¶ŠOOP,ç¬¬1éƒ¨åˆ†</a></li><li class="chapter-item expanded "><a href="../tip/oop-2-polymorphism.html" class="active"><strong aria-hidden="true">4.4.</strong> Rust è¶…è¶ŠOOP,ç¬¬2éƒ¨åˆ†</a></li><li class="spacer"></li></ol></li><li class="chapter-item "><a href="../log/index.html"><strong aria-hidden="true">5.</strong> ç¬”è®°</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../log/rust-s-ugly-syntax.html"><strong aria-hidden="true">5.1.</strong> Rust ä¸‘å¥æ³•</a></li><li class="chapter-item "><a href="../log/rust101logging.html"><strong aria-hidden="true">5.2.</strong> Rust è¯¾ç¨‹ç¬”è®°</a></li><li class="chapter-item "><a href="../log/graph-rust-move-copy-borrow.html"><strong aria-hidden="true">5.3.</strong> å›¾å½¢æè¿° Rust ä¸­æ‰€æœ‰æƒå’Œå€Ÿç”¨</a></li></ol></li></ol>
        </div>
        <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
    </nav>

    <div id="page-wrapper" class="page-wrapper">

        <div class="page">
                        <div id="menu-bar-hover-placeholder"></div>
            <div id="menu-bar" class="menu-bar sticky bordered">
                <div class="left-buttons">
                    <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                        <i class="fa fa-bars"></i>
                    </button>
                    <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                        <i class="fa fa-paint-brush"></i>
                    </button>
                    <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                        <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button>
                        </li>
                    </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                        aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                        aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
                </div>

                <h1 class="menu-title">be Rustaceans</h1>

                <div class="right-buttons">
                    <a href="../print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/zhrust/rustacean/tree/main/src" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-github"></i>
                    </a>

                </div>
            </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..."
                        aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>

            <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
            <script type="text/javascript">
                document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                    link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                });
            </script>

            <div id="content" class="content">
                <!-- Page table of contents -->
                <div class="sidetoc">
                    <nav class="pagetoc"></nav>
                </div>
                <main>
                    <h1 id="rust-è¶…è¶Šé¢å‘å¯¹è±¡ç¬¬2éƒ¨åˆ†"><a class="header" href="#rust-è¶…è¶Šé¢å‘å¯¹è±¡ç¬¬2éƒ¨åˆ†">Rust è¶…è¶Šé¢å‘å¯¹è±¡,ç¬¬2éƒ¨åˆ†</a></h1>
<p>åŸæ–‡:<a href="https://www.thecodedmessage.com/posts/oop-2-polymorphism/">Rust Is Beyond Object-Oriented, Part 2: Polymorphism :: The Coded Message</a></p>
<h2 id="å¿«è¯‘"><a class="header" href="#å¿«è¯‘">å¿«è¯‘</a></h2>
<p>åœ¨è¿™ç¯‡æ–‡ç« ä¸­, é€šè¿‡è®¨è®º OOP ä¸‰å¤§ä¼ ç»Ÿæ”¯æŸ±ä¸­çš„ç¬¬äºŒä¸ª: å¤šæ€,
ç»§ç»­ç³»åˆ—æ–‡ç« :å…³äº Rust å’Œä¼ ç»Ÿ OOP èŒƒå¼çš„ä¸åŒ;</p>
<p>å¤šæ€æ€§æ˜¯é¢å‘å¯¹è±¡ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªç‰¹åˆ«é‡è¦çš„è¯é¢˜ï¼Œ
ä¹Ÿè®¸æ˜¯å…¶ä¸‰å¤§æ”¯æŸ±ä¸­æœ€é‡è¦çš„ä¸€ä¸ª;
å…³äºå¤šæ€æ€§æ˜¯ä»€ä¹ˆ, å„ç§ç¼–ç¨‹è¯­è¨€å¦‚ä½•å®ç°(åœ¨ OOP ä¸–ç•Œå†…å¤–---æ˜¯çš„,å¤šæ€æ€§ä¹Ÿå­˜åœ¨äº OOP å®‡å®™ä¹‹å¤–),
å¦‚ä½•æœ‰æ•ˆçš„ä½¿ç”¨, ä»¥åŠæ›´åŠ å…³é”®çš„ä½•æ—¶å«‘ä½¿ç”¨;
å¯ä»¥å†™ä¸€äº›å…³äºå¦‚ä½•å•ç‹¬ä½¿ç”¨å¤šæ€çš„ Rust ç‰ˆæœ¬çš„ä¹¦äº†;</p>
<p>ä¸å¹¸çš„æ˜¯, è¿™åªæ˜¯ä¸€ç¯‡ blog,æ‰€ä»¥,
æˆ‘æ— æ³•åƒæˆ‘æƒ³çš„é‚£æ ·è¯¦ç»†æˆ–æ˜¯å¤šæ ·æ€§çš„ä»‹ç»å¤šæ€;
ç›¸å,æˆ‘å°†ç‰¹åˆ«å…³æ³¨ Rust å’Œ OOP æ¦‚å¿µçš„ä¸åŒä¹‹å¤„;
æˆ‘å°†ä»æè¿°å…¶åœ¨ OOP ä¸­çš„å·¥ä½œæ–¹å¼å¼€å§‹,
ç„¶å, è®¨è®ºå¦‚ä½•åœ¨ Rust ä¸­å®ç°ç›¸åŒçš„ç›®æ ‡;</p>
<p>åœ¨ OOP ä¸­,å¤šæ€æ€§å°±æ˜¯ä¸€åˆ‡;
è¯•å›¾é‡‡å–æ‰€æœ‰å†³ç­–(æˆ–æ˜¯å°½å¯èƒ½å¤šçš„å†³ç­–)å¹¶å°†å…¶ç»Ÿä¸€åœ¨ä¸€ä¸ªé€šç”¨çš„ç‹­ä¹‰æœºåˆ¶ä¸­:
è¿è¡Œæ—¶å¤šæ€;
ä½†æ˜¯, ä¸å¹¸çš„æ˜¯, å¹¶ä¸æ˜¯ä»»æ„è¿è¡Œæ—¶å¤šæ€, è€Œæ˜¯ä¸€ç§ç‰¹å®šçš„/ç‹­ä¹‰çš„è¿è¡Œæ—¶å¤šæ€å½¢å¼,
å—åˆ° OOP å“²å­¦å’Œå®ç°å¦‚ä½•å·¥ä½œç»†èŠ‚çš„é™åˆ¶:</p>
<ul>
<li>é—´æ¥éœ€æ±‚: æ¯ä¸ªå¯¹è±¡é€šå¸¸éƒ½å¿…é¡»å­˜å‚¨åœ¨å †ä¸Š,æ‰èƒ½ä½¿è¿è¡Œæ—¶å¤šæ€ç”Ÿæ•ˆ, å› ä¸º,ä¸åŒçš„&quot;è¿è¡Œæ—¶ç±»å‹&quot;å…·æœ‰ä¸åŒçš„å°ºå¯¸; è¿™é¼“åŠ±äº†å¯å˜å¯¹è±¡çš„åˆ«åä½¿ç”¨;ä¸ä»…å¦‚æ­¤,è¦çœŸæ­£è°ƒç”¨ä¸€ä¸ªæ–¹æ³•,å¿…é¡»ç©¿è¿‡ä¸‰å±‚é—´æ¥:
<ul>
<li>è§£å¼•ç”¨å¯¹è±¡å¼•ç”¨</li>
<li>è§£å¼•ç”¨ç±»æŒ‡é’ˆæˆ–æ˜¯ â€œvtableâ€ æŒ‡é’ˆ</li>
<li>æœ€åå®Œæˆé—´æ¥å‡½æ•°è°ƒç”¨</li>
</ul>
</li>
<li>æ’æ–¥ä¼˜åŒ–: é™¤äº†é—´æ¥å‡½æ•°è°ƒç”¨çš„å†…åœ¨æˆæœ¬ä¹‹å¤–, è°ƒç”¨æ˜¯é—´æ¥çš„è¿™ä¸€äº‹å®, æ„å‘³ç€å†…è”æ˜¯ä¸å¯èƒ½çš„ï¼›é€šå¸¸,å¤šæ€æ–¹æ³•å¾ˆå°,ç”šè‡³äºå¾®ä¸è¶³é“,ä¾‹å¦‚è¿”å›å¸¸é‡/è®¾ç½®å­—æ®µæˆ–æ˜¯é‡æ–°æ’åˆ—å‚æ•°å¹¶è°ƒç”¨å¦ä¸€ä¸ªæ–¹æ³•, å› æ­¤, å†…è”ä¼šå¾ˆæœ‰ç”¨; å†…è”å¯¹äºå…è®¸ä¼˜åŒ–è·¨å†…è”è¾¹ç•Œä¹Ÿå¾ˆé‡è¦;</li>
<li>ä»…èƒ½åœ¨å•ä¸€å‚æ•°ä¸Šå¤šæ€: ç‰¹æ®Šçš„æ¥æ”¶è€…å‚æ•°,ç§°ä¸º self æˆ–æ˜¯ this, æ˜¯è¿è¡Œæ—¶å¤šæ€ä¹Ÿçš„å¹¶ä¸Šé€šå¸¸å¯èƒ½é€šè¿‡çš„å”¯ä¸€å‚æ•°; å…¶å®ƒå‚æ•°çš„å¤šæ€å¯ä»¥ç”¨é‚£äº›ç±»å‹ä¸­çš„è¾…åŠ©æ–¹å¼æ¥æ¨¡æ‹Ÿ, è¿™å°±å¾ˆå°´å°¬, è€Œä¸”, è¿”å›ç±»å‹çš„å¤šæ€ä¹Ÿæ˜¯ä¸å¯èƒ½çš„;</li>
<li>æ¯ä¸ªå€¼éƒ½æ˜¯ç‹¬ç«‹å¤šæ€çš„: åœ¨è¿è¡Œæ—¶å¤šæ€ä¸­, é€šå¸¸æ²¡æœ‰åŠæ³•è¯´é›†åˆçš„æ‰€æœ‰å…ƒç´ éƒ½å±äºå®ç°ç›¸åŒæ¥å£/interface çš„æŸç§ç±»å‹ T,ä½†æ˜¯, è¯¥ç±»å‹æ˜¯ä»€ä¹ˆåˆåº”è¯¥åœ¨è¿è¡Œæ—¶èƒ½ç¡®å®š;</li>
<li>å’Œå…¶å®ƒ OOP ç‰¹æ€§çº ç¼ åœ¨ä¸€èµ·: åœ¨ C++ ä¸­,è¿è¡Œæ—¶å¤šæ€å’Œç»§æ‰¿ç´§å¯†è€¦åˆï¼›ã€€åœ¨å¾ˆå¤š OOP è¯­è¨€ä¸­, å¤šæ€ä»…é€‚ç”¨äºç±»çš„ç±»å‹, æ­£å¦‚æˆ‘åœ¨ä¸Šç¯‡ blog ä¸­è®¨è®ºçš„é‚£æ ·, ç±»ç±»å‹æ˜¯ä¸€ç§å—çº¦æŸçš„æ¨¡å—å½¢å¼;</li>
</ul>
<p>å…¶å®æˆ‘å®Œå…¨å¯ä»¥é’ˆå¯¹ä»¥ä¸Šæ¯æ¡åç³Ÿå•ç‹¬å†™ä¸€å¤§ç¯‡æ–‡ç«  --- ä¹Ÿè®¸æœ‰ä¸€å¤©çœŸçš„ä¼š;</p>
<p>ä¸è¿‡,å°½ç®¡æœ‰è¿™ä¹ˆå¤šé™åˆ¶, å¤šæ€ä»ç„¶è¢«è§†ä¸ºä½¿ç”¨ OOP è¯­è¨€è¿›è¡Œå†³ç­–çš„é¦–é€‰æ–¹å¼,
å¹¶ä¸”, ç‰¹åˆ«ç›´è§‚ä¸”æ˜“äºè®¿é—®;
å—è¿‡è®­ç»ƒçš„ç¨‹åºå‘˜, å˜¦å¯èƒ½å°±ä¸€å®šä½¿ç”¨æ­¤å·¥å…·,
æ— è®ºæ˜¯å¦æ˜¯æ‰‹ä¸Šå†³ç­–æ˜¯æœ€ä½³å·¥å…·, å³ä¾¿å½“å‰ä¸éœ€è¦ç”¨å¤šæ€è¿›è¡Œè¿è¡Œæ—¶å†³ç­–;
æœ‰äº›ç¼–ç¨‹è¯­è¨€,ä¾‹å¦‚ Smalltalk ç”šè‡³æŠ˜å äº† &quot;if-then&quot; é€»è¾‘,
å¹¶å¾ªç¯åˆ° this è¿™ä¸ªå¥‡æ€ªçš„ç‰¹å®šå†³ç­–ç»“æ„ä¸­,
é€šè¿‡å¤šæ€æ–¹æ³•(å¦‚: ifTrue:idFalse)æœ€ç»ˆå®ç°,
è¿™äº›æ–¹æ³•å°†åœ¨ True å’Œ False ç±»ä¸­ä»¥ä¸åŒæ–¹å¼å†å®ç°
(å’Œ therefore åœ¨ true ä»¥åŠ false å¯¹è±¡ä¸Šé…å¥—);</p>
<p>éœ€è¦æ˜ç¡®çš„æ˜¯, æ‹¥æœ‰åŸºäº vtable çš„è¿è¡Œæ—¶å¤šæ€æ€§æœºåˆ¶æœ¬èº«å¹¶ä¸æ˜¯ä¸€ä»¶åäº‹å„¿ --- Rust ç”šè‡³æœ‰ä¹Ÿä¸€ä¸ª
(å’Œä¸Šè¿° OOP ç‰ˆæœ¬ç›¸ä¼¼,ä½†æ˜¯,å¹¶ä¸å®Œå…¨å¯¹ç­‰);
ä½†æ˜¯, Rust ç‰ˆæœ¬åªç”¨ä»¥ç›¸å¯¹ç½•è§çš„æƒ…å†µ, åœ¨è¿™ç§æƒ…å†µä¸­,
è¯¥æœºåˆ¶æœ€é€‚åˆæ•´ä¸ªå„¿ palette æœºåˆ¶;
åœ¨ OOP ä¸­, å°†è¿™ç§ä¸¥æ ¼çº¦æŸä¸”å¿¾å’Œç”¨ä½ä¸‹çš„å†³ç­–åˆ¶å®šå½¢å¼æå‡åˆ°æ‰€æœ‰å…¶å®ƒå½¢å¼ä¹‹ä¸Š,
ä»¥åŠä½¿ç”¨å¤šæ€æ˜¯è¡¨è¾¾ç¨‹åºæ³¨é‡Šå’Œä¸šåŠ¡ç¼–è¾‘çš„æœ€ä½³æ–¹å¼ä»¥åŠæœ€ç›´è§‚æ–¹å¼çš„å“²å­¦æ–­è¨€,
æœ¬èº«å°±æ˜¯ä¸ªé—®é¢˜;</p>
<p>äº‹å®è¯æ˜,å½“ä½ é€‰æ‹©æœ€é€‚åˆæ‰‹å¤´æƒ…å†µçš„å·¥å…·æ—¶, ç¼–ç¨‹æ›´åŠ å»åˆäººä½“å·¥ç¨‹å­¦ --- è€Œ OOP è¿è¡Œæ—¶å¤šæ€æ€§,
åªæ˜¯å¶å°”æ‰æ˜¯æœ€åˆé€‚å®Œæˆå½“å‰å·¥ä½œçš„å®æ•ˆå·¥å…·;</p>
<p>å› æ­¤, è®©æˆ‘ä»¬çœ‹çœ‹åœ¨ OOP ä½¿ç”¨è¿è¡Œæ—¶å¤šæ€æ€§æ—¶, å¯ä»¥ä½¿ç”¨çš„ Rust ç‰ˆå››ç§æ›¿ä»£æ–¹æ¡ˆ;</p>
<h3 id="å¤‡é€‰æ–¹æ¡ˆ0æšä¸¾"><a class="header" href="#å¤‡é€‰æ–¹æ¡ˆ0æšä¸¾">å¤‡é€‰æ–¹æ¡ˆ#0ï¼šæšä¸¾</a></h3>
<p>ä¸ä»…æœ‰å…¶å®ƒå½¢å¼çš„å¤šæ€æ€§, è€Œä¸”å…·æœ‰æ›´å°‘çš„ä¸¥æ ¼çº¦æŸ
(ä¾‹å¦‚ Haskell çš„ç±»å‹ç±»)æˆ–ä¸€ç»„ä¸åŒçš„æƒè¡¡
(ä¾‹å¦‚ Rust çš„ trait,ä¸»è¦åŸºäº Haskell ç±»å‹ç±»),
Rust ä¸­è¿˜æœ‰å¦å¤–ä¸€ä¸ªå†³ç­–ç³»ç»Ÿ, å³:ä»£æ•°æ•°æ®ç±»å‹(ADTs, algebraic data types)
æˆ–æ›°æ±‚åˆ/sum ç±»å‹,
ä¹Ÿèƒ½æ¥ç®¡ OOP æ ·å¼å¤šæ€çš„å¾ˆå¤šåº”ç”¨ç¨‹åº;</p>
<p>åœ¨ Rust ä¸­, è¿™äº›è¢«ç§°ä¸º æšä¸¾/enums;
å¾ˆå¤šç¼–ç¨‹è¯­è¨€ä¸­çš„æšä¸¾æ˜¯å­˜å‚¨åœ¨æ•´æ•°å°ºå¯¸ç±»å‹ä¸­çš„å¸¸é‡åˆ—è¡¨,
æœ‰æ—¶ä»¥ç±»å‹å®‰å…¨çš„æ–¹å¼å®ç°(æ¯”å¦‚åœ¨ Java ä¸­),
æœ‰æ—¶ä¸æ˜¯(æ¯”å¦‚åœ¨ C ä¸­),
æœ‰æ—¶å¯ä»¥ä½¿ç”¨ä»»ä½•ä¸€ç§é€‰é¡¹(æ¯”å¦‚,åœ¨ C++ ä¸­æšä¸¾å’Œæšä¸¾ç±»ä¹‹é—´å°±æœ‰åŒºåˆ«);</p>
<p>Rust æšä¸¾æ”¯æŒè¿™ç§ç†Ÿæ‚‰çš„ç”¨ä¾‹, è€Œä¸”å…·æœ‰ç±»å‹å®‰å…¨:</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum Visibility {
    Visible,
    Invisible,
}
<span class="boring">}</span></code></pre></pre>
<p>ä½†æ˜¯, è¿˜æ”¯æŒå’Œæ¯ä¸ªé€‰é¡¹å…³è”çš„é™„åŠ å­—æ®µ,
åˆ›å»ºç±»å‹ç†è®ºä¸­ç§°ä¸º&quot;æ€»å’Œç±»å‹&quot;(sum type)çš„ä¸œè¥¿,
ä½†åœ¨ C æˆ–æ˜¯ C++ ç¨‹åºå‘˜ä¸­æ›´åŠ å¹¿ä¸ºäººçŸ¥è¯†çš„å«&quot;è”åˆæ ‡è®°&quot;(tagged union)
--- ä¸åŒä¹‹å¤„åœ¨äº, Rust ä¸­, ç¼–è¯‘å™¨çŸ¥é“å¹¶èƒ½å¼ºåˆ¶æ‰§è¡Œæ ‡è®°;</p>
<p>ä»¥ä¸‹æ˜¯ä¸€äº›æšä¸¾å£°æ˜çš„ç¤ºä¾‹:</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub enum UserId {
    Username(String),
    Anonymous(IpAddress),
    // ^^ This isn't supposed to be a real network type,
    // just an example.
}

let user1 = User::Username(&quot;foo&quot;.to_string());
let user2 = User::Anonymous(parse_ip(&quot;127.0.0.1&quot;)?);

pub enum HostIdentifier {
    Dns(DomainName),
    Ipv4Addr(Ipv4Addr),
    Ipv6Addr(Ipv6Addr),
}

pub enum Location {
    Nowhere,
    Address(Address),
    Coordinates {
        lat: f64,
        long: f64,
    }
}

let loc1 = Location::Nowhere;
let loc2 = Location::Coordinates {
    lat: 80.0,
    long: 40.0,
};
<span class="boring">}</span></code></pre></pre>
<p>ä½ å¯èƒ½ä¼šé—®,è¿™äº›<code>è”åˆæ ‡è®°</code>å’Œå¤šæ€æœ‰ä»€ä¹ˆå…³ç³»?
å¥½å§, å¤§å¤šæ•° OOP è¯­è¨€å¯¹äºè¿™äº› æ±‚åˆç±»å‹/sum type æ²¡ä»€ä¹ˆå¥½åŠæ³•,
ä½†æ˜¯, å¥¹ä»¬ç¡®å®æœ‰å¼ºå¤§çš„è¿è¡Œæ—¶å¤šæ€æœºåˆ¶,
æ‰€ä»¥, ä½ ä¼šçœ‹åˆ°è¿è¡Œæ—¶å¤šæ€ç”¨ Rust æšä¸¾å®ç°ä¹Ÿæ˜¯ä¸€æ ·çš„é€‚åˆ
(æˆ‘å¯èƒ½è¿›ä¸€æ­¥äº‰è¾©: æ›´åŠ åˆé€‚):
æ¯å½“æœ‰ä¸€äº›å°å…³äºå¦‚ä½•åå•†ä¼šè®®å€¼çš„é€‰é¡¹, ä½†æ˜¯,è¿™äº›é€‰é¡¹åˆåŒ…å«ä¸åŒç»†èŠ‚æ—¶;</p>
<p>æ¯”å¦‚, è¿™æ˜¯ä¸€ç§ä½¿ç”¨ç»§æ‰¿å’Œè¿è¡Œæ—¶å¤šæ€åœ¨ Java ä¸­è¡¨ç¤º UserId ç±»å‹çš„æ–¹æ³• --- å½“æˆ‘è¿˜æ˜¯å­¦ç”Ÿæ—¶, 
è‚¯å®šä¼šè¿™ä¹ˆæ¥(å°†æ¯ä¸ªç±»æ”¾åœ¨ä¸åŒçš„æ–‡ä»¶ä¸­):</p>
<pre><code class="language-java">class UserId {
}

class Username extends UserId {
    private String username;
    public Username(String username) {
        this.username = username;
    }

    // ... getters, setters, etc.
}

class AnonymousUser extends UserId {
    private Ipv4Address ipAddress;
    
    // ... constructor, getters, setters, etc.
}

UserId user1 = new Username(&quot;foo&quot;);
UserId user2 = new AnonymousUser(new Ipv4Address(&quot;127.0.0.1&quot;));
</code></pre>
<p>é‡è¦çš„æ˜¯, å°±åƒåœ¨æšä¸¾ç¤ºä¾‹ä¸­ä¸€æ ·,
æˆ‘ä»¬å¯ä»¥å°† user1 å’Œ user2 ç»™å®šç›¸åŒç±»å‹çš„å˜é‡,
å¹¶å°†å¥¹ä»¬å¾—ç‹®ç»™ç›¸åŒç±»å‹çš„å‡½æ•°, å¹¶é€šå¸¸å¯¹å¥¹ä»¬æ‰§è¡Œç›¸åŒçš„æ“ä½œ;</p>
<p>ç°åœ¨è¿™äº› OOP é£æ ¼çš„ç±»çœ‹èµ·æ¥è½»é£˜åˆ°é£æº…çš„ç¨‹åº¦,
ä½†æ˜¯, è¿™ä¸»è¦æ˜¯å› ä¸ºæˆ‘ä»¬æ²¡æœ‰ä¸ºè¿™ç§æƒ…å†µæ·»åŠ ä»»ä½•çœŸæ­£çš„æ“ä½œä»£ç  --- åªæœ‰æ•°æ®å’Œç»“æ„, 
ä»¥åŠä¸€äº›å˜é‡å®šä¹‰å’Œæ¨¡æ¿;
è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹, å¦‚æœæˆ‘ä»¬çœŸçš„å¯¹ç”¨æˆ· ID å°è¯•è¿›è¡Œä»»ä½•æ“ä½œæ—¶ä¼šæ€ä¹ˆæ ·?</p>
<p>ä¾‹å¦‚,æˆ‘ä»¬å¯èƒ½æƒ³ç¡®è®¤å¥¹ä»¬æ˜¯å¦ä¸ºç®¡ç†å‘˜;
åœ¨æˆ‘ä»¬çš„å‡è®¾ä¸­, å‡è®¾åŒ¿åç”¨æˆ·æ°¸è¿œä¸æ˜¯ç®¡ç†å‘˜,
è€Œæ‹¥æœ‰ç”¨æˆ·åçš„ç”¨æˆ·åªæœ‰åœ¨ç”¨æˆ·åä»¥å­—ç¬¦ä¸² admin_ å¼€å¤´æ—¶,æ‰æ˜¯ä½ç®¡ç†å‘˜;</p>
<p>ç†è®ºä¸Šè®¤å¯çš„ OOP æ–¹æ³•æ˜¯æ·»åŠ ä¸€ä¸ªæ–¹æ³•,
æ¯”å¦‚: administrator;
ä¸ºäº†è®©è¿™ä¸ªæ–¹æ³•èµ·ä½œç”¨, æˆ‘ä»¬å¿…é¡»å°†å…¶è¿½åŠ åˆ°æ‰€æœ‰ä¸‰ä¸ªç±»: åŸºæ•°ä»¥åŠä¸¤ä¸ªå­ç±»:</p>
<pre><code class="language-java">class UserId {
    // ...
    public abstract bool isAdministrator();
}

class Username extends UserId {
    // ...
    public bool isAdministrator() {
        return username.startsWith(&quot;admin_&quot;);
    }
}

class AnonymousUser extends UserId {
    // ...
    public bool isAdminstrator() {
        return false;
    }
}
</code></pre>
<p>å› æ­¤, ä¸ºäº†åœ¨ Java ä¸­ä¸ºè¿™ç§ç±»å‹æ·»åŠ è¿™ç§ç®€å•çš„æ“ä½œ,å¦‚æ­¤ç®€å•çš„èƒ½åŠ›,
æˆ‘ä»¬å´å¿…é¡»ä½¿ç”¨ä¸‰ä¸ªç±»,
è€Œä¸”å¿…é¡»å­˜å‚¨åœ¨ä¸‰ä¸ªæ–‡ä»¶ä¸­;
ä¸«ä»¬æ¯ä¸ªå¯¹è±¡éƒ½åŒ…å«ä¸€ä¸ªæ–¹æ³•æ¥ä½œä¸€äº›ç®€å•çš„äº‹å„¿,
ä½†æ˜¯, åœ¨ä»»ä½•ç¾Œæ—éƒ½çœ‹ä¸åˆ°è°æ˜¯ç®¡ç†å‘˜, åˆæˆ–è€…ä¸æ˜¯ç®¡ç†å‘˜çš„å®Œæ•´é€»è¾‘ --- æœ‰äººå¯èƒ½ä¼šå¾ˆä¸åˆæ—¶å®œçš„é—®å‡ºè¿™ä¸ªé—®é¢˜;</p>
<p>Rust åˆ™ä¸ºè¿™ç§æ“ä½œä½¿ç”¨ match,
å°†æœ‰å…³æ‰€æœ‰ä¿¡æ¯æ”¾åœ¨ä¸€ä¸ªåœ°æ–¹å®Œæˆåˆ¤å®š:</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>fn is_administrator(user: &amp;UserId) -&gt; bool {
    match user {
        UserId::Username(name) =&gt; name.starts_with(&quot;admin_&quot;),
        UserId::AnonymousUser(_) =&gt; false,
    }
}
<span class="boring">}</span></code></pre></pre>
<p>è¯šç„¶, è¿™å°†äº§ç”Ÿæ›´åŠ å¤æ‚çš„å•ä¸ªå‡½æ•°,
ä½†æ˜¯,å…·æœ‰æ˜ç¡®çš„æ‰€æœ‰é€»è¾‘;
è®©ç¼–è¾‘æ˜æ˜¾è€Œä¸æ˜¯éšå«åœ¨ç»§æ‰¿å±¡æ¬¡ç»“æ„ä¸­, 
è¿™å°±è¿åäº† OOP åŸåˆ™, 
åœ¨ OOP å®‡å®™ä¸­, æ–¹æ³•åº”è¯¥ç®€å•, å¤šæ€æ€§ç”¨äºéšå«çš„è¡¨è¾¾é€»è¾‘;
ä½†æ˜¯,è¿™å¹¶ä¸èƒ½ä¿è¯ä»»ä½•äº‹å„¿, åªæ˜¯å°†å…¶æ‰«åˆ°åœ°æ¯¯ä¸‹è€Œå·²:
äº‹å®è¯æ˜, éšè—å¤æ‚æ€§ä¼šä»¤å…¶æ›´éš¾åº”å¯¹, è€Œä¸æ˜¯ç›¸å;</p>
<p>è®©çš„æˆ‘ä»¬æ¥çœ‹å¦å¤–ä¸€ä¸ªä¾‹å­;
æˆ‘ä»¬å·²ç»ç”¨äº†ä¸€æ®µæ—¶é—´çš„ UserId ä»£ç ,
ä½ çš„ä»»åŠ¡æ˜¯ä¸ºè¿™ä¸ªç³»ç»Ÿç¼–å†™ä¸€ä¸ªæ–°çš„ Web å‰ç«¯;
ä½ éœ€è¦æŸç§æ–¹å¼, ä»¥ HTML æ ¼å¼æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯,
è¦ä¹ˆæ˜¯æŒ‡å‘ç”¨æˆ·é…ç½®æ–‡ä»¶çš„é“¾æ¥(å¯¹äºæŒ‡å®šç”¨æˆ·),
è¦ä¹ˆæ˜¯å°† IP åœ°å€å­—ç¬¦ä¸²åŒ–ä¸ºçº¢è‰²(å¯¹äºåŒ¿åç”¨æˆ·);
å› æ­¤, ä½ å†³å®šä¸ºè¿™ä¸ªå°å‹ç±»å‹è¿½åŠ ä¸€ä¸ªæ–°æ“ä½œ toHTML,
å°†è¾“å‡ºæ–°å‰ç«¯çš„ä¸“ç”¨ DOM ç±»å‹;
(ä¹Ÿè®¸ Java è¢«ç¼–è¯‘ä¸º WebAssembly å‘¢? æˆ‘ä¹Ÿä¸ç¡®å®š,ä¸è¿‡ç»†èŠ‚ä¸é‡è¦;-)</p>
<p>ä½ é€ˆåç«¯æ ¸å¿ƒåº“æ·±å…¥çš„ UserId ç±»å±¡æ¬¡ç»“æ„çš„ç»´æŠ¤è€…æäº¤äº† pull request;
ç„¶å, ä»–ä»¬æ‹’ç»äº†;</p>
<p>äº‹å®ä¸Š, ä»–ä»¬æœ‰å¾ˆå¥½çš„ç†ç”±, ä½ å¿…é¡»å‹‰å¼ºæ‰¿è®¤;
ä»–ä»¬è¯´:&quot;è¿™æ˜¯ä¸€ç§è’è°¬çš„å…³æ³¨ç‚¹åˆ†ç¦»&quot;;
æ­¤å¤–, å…¬å¸ä¹Ÿæ— æ³•ä»ä½ çš„å‰ç«¯è·å¾—æ­¤æ ¸å¿ƒåº“å¤„ç†ç±»å‹;</p>
<p>æ‰€ä»¥, ä½ å¹äº†å£æ°”, å†™äº†ä¸ª Rust åŒ¹é…è¡¨è¾¾å¼çš„ç­‰ä»·ç‰©, ä½†æ˜¯ç”¨çš„æ˜¯ Java
(è¯·åŸè°…æˆ‘è’è°¬çš„å‡è®¾æœ‰ä¸ª HTML åº“):</p>
<pre><code class="language-java">Html userIdToHtml(UserId userId) {
    if (userId instanceof Username) {
        Username username = (Username)userId;
        String usernameString = username.getUsername();
        Url url = ProfileHandler.getProfileForUsername(usernameString);
        return Link.createTextLink(url, username.getUsername());
    } else if (userId instanceof AnonymousUser) {
        AnonymousUser anonymousUser = (AnonymousUser)userId;
        return Span.createColoredText(anonymousUser.getIp().formatString(), &quot;red&quot;);
    } else {
        throw new RuntimeException(&quot;IDK, man&quot;);
    }
}
</code></pre>
<p>ä½ çš„è€æ¿ä»¬åœ¨ä»£ç å®¡æŸ¥æ—¶æ‹’ç»äº†è¿™æ®µä»£ç ,
ä½ ä½ ä½¿ç”¨äº† instanceof åæ¨¡å¼,
ä½†æ˜¯, åæ¥åœ¨ä½ è®©ä»–ä»¬å’Œä¸æ¥å—ä½ çš„å…¶å®ƒè¡¥ä¸çš„æ ¸å¿ƒåº“ç»´æŠ¤è€…äº‰è®ºä¹‹å,
ä¸«ä»¬å‹‰å¼ºæ¥å—äº†è¿™æ®µä»£ç ;</p>
<p>ä½†æ˜¯, çœ‹çœ‹é‚£å¨ instanceof ä»£ç æœ‰å¤šéš¾çœ‹!
éš¾æ€ª Java ç¨‹åºå‘˜è®¤ä¸ºè¿™æ˜¯ä¸€ç§åæ¨¡å¼!
ä½†æ˜¯, åœ¨è¿™ç§æƒ…å†µä¸­, å·²ç»æ˜¯æœ€åˆç†çš„äº‹å„¿äº†,
å®é™…ä¸Š, æ˜¯é™¤äº†å®æ–½è§‚å¯Ÿè€…ä¸œè¥¿æ–¹æˆ–æ˜¯è®¿é—®è€…æ¨¡å¼åˆæˆ–æ˜¯å…¶å®ƒç›¸å½“äºåŸºç¡€è®¾æ–½çš„ä¸œè¥¿ä¹‹å¤–,
å”¯ä¸€å¯èƒ½çš„å®ç°, åªæ˜¯ç”¨æ¥åˆ›é€ å…·æœ‰æ§åˆ¶åè½¬çš„å®ä¾‹è€Œå·²;</p>
<p>å½“æ“ä½œé›†æœ‰ç•Œ(æˆ–æ˜¯æ¥è¿‘æœ‰é™)å¹¶ä¸”è¯¥ç±»çš„å­ç±»æ•°é‡å¯èƒ½ä»¥æ„æƒ³ä¸åˆ°çš„æ–¹å¼å¢é•¿æ—¶,
é€šè¿‡å‘æ¯ä¸ªå­ç±»è¿½åŠ ä¸€ä¸ªæ–¹æ³•æ¥å®ç°æ“ä½œæ˜¯æœ‰æ„ä¹‰çš„;
å¯æ˜¯,é€šå¸¸æƒ…å†µä¸­, æ“ä½œçš„æ•°é‡åˆä¼šä»¥æ„æƒ³ä¸åˆ°çš„æ–¹å¼å¢é•¿,
è€Œå­ç±»çš„æ•°é‡æ€»æ˜¯æœ‰é™çš„(åˆæˆ–æ˜¯æ¥è¿‘æœ‰é™);</p>
<p>å¯¹äºåä¸€ç§æƒ…å†µ, è¿™ç§æƒ…å†µæ¯” OOP æ‹¥æŠ¤è€…æƒ³è±¡çš„æ›´åŠ å¸¸è§,
Rust æšä¸¾ --- ä»¥åŠä¸€èˆ¬çš„ æ±‚å’Œç±»å‹ --- æ˜¯å®Œç¾çš„;
ä¸€ä½†ä½ ä¹ æƒ¯äº†å¥¹ä»¬, ä½ å°±ä¼šå‘ç°è‡ªå·±ä¸€ç›´åœ¨ä½¿ç”¨;</p>
<p>æˆ‘è¦éƒ‘é‡å£°æ˜,
åœ¨æ‰€æœ‰é¢å‘å¯¹è±¡çš„ç¼–ç¨‹è¯­è¨€ä¸­,éƒ½æ²¡æœ‰è¿™ä¹ˆç³Ÿç³•;
åœ¨æŸäº›æƒ…å†µä¸­, ä½ å¯ä»¥æŒ‰ä»»ä½•é¡ºåºç¼–å†™ä»»æ„ç±»æ–¹æ³•ç»„åˆ,
å› æ­¤,å¦‚æœä½ æ„¿æ„, å¯ä»¥å°†æ‰€æœ‰ä¸‰ä¸ªå®ç°å†™åœ¨ä¸€ä¸ªåœ°æ–¹;
Smalltalk ä¼ ç»Ÿä¸Šå…è®¸ä½ åœ¨ä¸€ä¸ªç‰¹æ®Šçš„æµè§ˆå™¨ä¸­æ¸¸è§ˆä»£ç åº“,
ä½ å¯ä»¥åœ¨å…¶ä¸­çœ‹åˆ°ä¸€ä¸ªç±»å®ç°çš„æ–¹æ³•åˆ—è¡¨,
æˆ–è€…ä¸€ä¸ªæ¥å—ç»™å®š&quot;æ¶ˆæ¯&quot;çš„ç±»åˆ—è¡¨,
æ­£å¦‚ Smalltalk æ‰€è¯´çš„é‚£æ ·,
è¿™æ ·ä½ å°±å¯ä»¥éšå¿ƒæ‰€æ¬²çš„æ“å¼„å¯¹è±¡äº†;</p>
<p>(è¯‘æŒ‰: å½“ç„¶, ä½ å¿…é¡»åœ¨ Salltalk å¯¹åº”è§£é‡Šå™¨çš„ IDE ç¯å¢ƒä¸­, ä¸€ä½†å‡ºäº†è¿™ä¸ªå¯¹è±¡é•œåƒ, å°†å¤±å»ä¸€åˆ‡è§‚å¯Ÿèƒ½åŠ›, è¿™å¯¼è‡´ Smalltalk æ²¡åŠæ³•ä½¿ç”¨å…¶å®ƒä¼ ç»Ÿ IDE)</p>
<h3 id="å¤‡é€‰æ–¹æ¡ˆ-1-é—­åŒ…"><a class="header" href="#å¤‡é€‰æ–¹æ¡ˆ-1-é—­åŒ…">å¤‡é€‰æ–¹æ¡ˆ #1: é—­åŒ…</a></h3>
<blockquote>
<p>Alternative #1: Closures</p>
</blockquote>
<p>æœ‰æ—¶, ä¸€ä¸ª OOP æ¥å£æˆ–æ˜¯å¤šæ€å†³ç­–åªæ¶‰åŠä¸€ä¸ªå®é™…æ“ä½œ;
åœ¨è¿™ç§æƒ…å†µä¸­,åªèƒ½ä½¿ç”¨é—­åŒ…;</p>
<p>æˆ‘ä¸æƒ³åœ¨è¿™æ–¹é¢èŠ±å¤ªå¤šæ—¶é—´,
å› ä¸º, å¤§å¤šæ•° OOP ç¨‹åºå‘˜å·²ç»æ„è¯†åˆ°è¿™ç‚¹,
å¹¶ä¸”, è‡ªä»ä»–ä»¬çš„ OOP è¯­è¨€å·²ç»èµ¶ä¸Šäº†å‡½æ•°å¼è¯­è¨€,
å¹¶è·å¾—äº† lambda è¯­æ³• --- Java ä¸­çš„ Java 8 ,
C++ ä¸­çš„, C++11;
å› æ­¤, åƒ Java çš„ Comparator è¿™ç§æ„šè ¢çš„å•ä¸€æ–¹æ³•æ¥å£ ---
å¹¸è¿çš„æ˜¯ --- åŸºæœ¬ä¸Šå·²ç»éƒ½æ„ŸæŸ“è¿‡å»å¼äº†;</p>
<p>æ­¤å¤–, Rust ä¸­çš„é—­åŒ…åœ¨æŠ€æœ¯ä¸Šæ¶‰åŠ traits,
å› æ­¤,ä½¿ç”¨å’Œæ¥ä¸‹æ¥çš„ä¸¤ä¸ªæ›¿ä»£æ–¹æ¡ˆç›¸åŒçš„æœºåˆ¶æ¥ç«€,
æ‰€ä»¥,ä¹Ÿæœ‰äººå¯èƒ½ä¼šäº‰è¾©è¯´è¿™åœ¨ Rust ä¸­å¹¶ä¸æ˜¯çœŸæ­£çš„ç‹¬ç«‹é€‰é¡¹;
ç„¶è€Œ,åœ¨æˆ‘çœ‹æ¥ lambda/é—­åŒ…å’Œ
FnMut/FnOnce/Fn ç­‰ trait ä»¬åœ¨ç¾å­¦ä¸Šå’Œæƒ…å¢ƒä¸Šéƒ½éå¸¸ç‰¹åˆ«,
å€¼å¾—èŠ±ç‚¹æ—¶é—´æŒæ¡;</p>
<p>å› æ­¤, æˆ‘å°†èŠ±äº›æ—¶æ—¶é—´æ¥è¯´æ˜è¿™ç‚¹:
å¦‚æœä½ å‘ç°è‡ªå·±åªä½¿ç”¨ä¸€ç§æ–¹æ³•ç¼–å†™ trait 
(Java æ¥å£æˆ–æ˜¯ C++ ç±»),
è¯·è€ƒè™‘ä½ æ˜¯å¦åº”è¯¥æ”¹ç”¨æŸç§é—­åŒ…æˆ–æ˜¯ lambda ç±»å‹;
æ¯•ç«Ÿåªæœ‰ä½ è‡ªå·±æ‰èƒ½é˜²æ­¢è¿‡åº¦è®¾è®¡;</p>
<h3 id="å¤‡é€‰æ–¹æ¡ˆ2-å…·æœ‰traitsçš„å¤šæ€"><a class="header" href="#å¤‡é€‰æ–¹æ¡ˆ2-å…·æœ‰traitsçš„å¤šæ€">å¤‡é€‰æ–¹æ¡ˆ#2: å…·æœ‰Traitsçš„å¤šæ€</a></h3>
<p>å°±åƒ Rust æœ‰ä¸ªæ¯” OOP ç±»æ¦‚å¿µæ›´åŠ çµæ´»/å¼ºå¤§çš„å°è£…ç‰ˆæœ¬,
æ­£å¦‚åœ¨ä¸Šç¯‡æ–‡ç« ä¸­è®¨è®ºçš„é‚£æ ·,
Rust æœ‰ä¸€ä¸ªæ¯” OOP å‡è®¾æ›´åŠ å¼ºå¤§çš„å¤šæ€ç‰ˆæœ¬: trait;</p>
<p>trait å°±åƒæ¥è‡ª Java çš„æ¥å£
(åˆæˆ–æ˜¯ C++ ä¸­çš„å…¨æŠ½è±¡è¶…ç±»),
ä½†æ˜¯,å¹¶æ²¡æœ‰æˆ‘åœ¨æ–‡ç« å¼€å¤´æŒ‡å‡ºçš„å¤§éƒ¨åˆ†é™åˆ¶;
trait å³æ²¡æœ‰è¯­ä¹‰çº¦æŸ, ä¹Ÿæ²¡æœ‰æ€§èƒ½çº¦æŸ;
trait åœ¨è¯­ä¹‰å’ŒåŸç†æ–¹é¢æ·±å— C++ æ¨¡æ¿çš„å¯å‘;
C++ ç¨‹åºå‘˜å¯ä»¥å°†å…¶è§†ä¸ºå¸¦æœ‰concepts/æ¦‚å¿µçš„æ¨¡æ¿
(é™¤éè®¾è®¡çš„,ä»ä¸€å¼€å§‹å°±èå…¥ç¼–ç¨‹è¯­è¨€,
è€Œä¸”ä¸å¿…è¦å¤„ç†æ‰€æœ‰ä¸ä½¿ç”¨å®ƒçš„ä»£ç ;)</p>
<p>è®©æˆ‘ä»¬ä»è¯­ä¹‰å¼€å§‹:
ä½ å¯ä»¥ä½¿ç”¨ trait å®Œæˆé‚£äº›æ— æ³•ä½¿ç”¨çº¯ OOP å®Œæˆçš„,
å³ä¾¿ä½ å°†ä¸–ç•Œä¸Šæ‰€æœ‰çš„é—´æ¥è°ƒç”¨éƒ½ä¸¢ç»™å¥¹?
å¥½å§, åœ¨çº¯ç²¹çš„ OOP æœ¯è¯­ä¸­,
æ˜¯æ— æ³•ç¼–å†™åƒ Rust Eq å’Œ Ord è¿™æ ·çš„æ¥å£,
è¿™é‡Œç»™å‡ºäº†éå¸¸ç®€å•çš„å®šä¹‰
(Eq å’Œ Ord çš„çœŸæ­£å®šä¹‰åœ¨äºæ‹“å±•äº†å…¶å®ƒå…è®¸ä¸åŒç±»å‹ä¹‹é—´çš„éƒ¨åˆ†ç­‰ä»·å’Œæ’åºçš„ç±»,
ä½†æ˜¯, åƒè¿™ç§ç®€åŒ–å®šä¹‰,
ééƒ¨åˆ† Eq å’Œ Ord çš„ Rust æ ‡å‡†åº“ç‰ˆæœ¬ç¡®å®šæ¶µç›–äº†ç›¸åŒç±»å‹å€¼ä¹‹é—´çš„ç­‰ä»·å’Œæ’åº):</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>trait Eq {
    fn eq(self, other: &amp;Self) -&gt; bool;
}

pub enum Ordering {
    Less,
    Equal,
    Greater,
}

trait Ord: Eq {
    fn cmp(&amp;self, other: &amp;Self) -&gt; Ordering;
}
<span class="boring">}</span></code></pre></pre>
<p>çœ‹çœ‹å‘ç”Ÿäº†ä»€ä¹ˆ?
å°±åƒåœ¨ OOP é£æ ¼çš„æ¥å£ä¸­ä¸€æ ·,
è¿™äº›æ— æ³•é‡‡ç”¨ Self ç±»å‹çš„â€œæ¥å—è€…â€ç±»å‹,
ä¸€ä¸ª self ç§‹ç²® -- ä¹Ÿå°±æ˜¯è¯´,ä»»ä½•å®ç° trait çš„å…·ä½“ç±»å‹
(æŠ€æœ¯ä¸Šè¿™é‡Œæ˜¯å¯¹ Self æˆ– &amp;Self çš„å¼•ç”¨);
ä½†æ˜¯, å’Œ OOP é£æ ¼çš„æ¥å£ä¸åŒ,
è¿™é‡Œè¿˜èƒ½é‡‡ç”¨å¦å¤–ä¸€ä¸ª &amp;Self ç±»å‹çš„å‚æ•°;
ä¸ºäº†å®ç° Eq å’Œ Ord,
ç±»å‹ T æä¾›äº†ä¸€ä¸ªå‡½æ•°,
è¯¥å‡½æ•°æ¥å—å¯¹ T çš„ä¸¤ä¸ªå¼•ç”¨;
å­—é¢ä¸Šçš„æ„æ€æ˜¯: å¯¹ T çš„ä¸¤ä¸ªå¼•ç”¨, è€Œä¸æ˜¯å¯¹ T çš„ä¸€ä¸ªå¼•ç”¨å’Œå¯¹ T æˆ–æ˜¯ä»»ä½•å­ç±»çš„ä¸€ä¸ªå¼•ç”¨
(è¿™æ ·çš„äº‹æƒ…åœ¨ Rust ä¸­å¹¶ä¸å­˜åœ¨),
ä¸æ˜¯å¯¹ T çš„ä¸€ä¸ªå¼•ç”¨å’Œå¯¹å®ç° Eq çš„ä»»ä½•å…¶å®ƒå€¼çš„ä¸€ä¸ªå¼•ç”¨,
è€Œæ˜¯å¯¹åŒä¸€å…·ä½“ç±»å‹çš„ä¸¤ä¸ªçœŸæ­£çš„éå¼‚æ„å¼•ç”¨,
ç„¶åï¼Œå‡½æ•°å°±å¯ä»¥æ¯”è¾ƒå¥¹ä»¬æ˜¯å¦ç›¸ç­‰(æˆ–æ˜¯è¿›è¡Œæ’åº);</p>
<p>è¿™ç‚¹å¾ˆå°±å°†è¦,å› ä¸º,
æˆ‘ä»¬æƒ³ç”¨è¿™ç§èƒ½åŠ›æ¥å®ç°åƒæ’åºè¿™ç±»æ–¹æ³•:</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>impl Vec&lt;T&gt; {
    pub fn sort(&amp;mut self) where T: Ord {
        // ...
    }
}
<span class="boring">}</span></code></pre></pre>
<p>OOP-style polymorphism is ideal for heterogeneous containers, where each element has its own runtime type and its own implementation of the interfaces. But sort doesnâ€™t work like that. You canâ€™t sort a collection like [3, &quot;Hello&quot;, true]; thereâ€™s no reasonable ordering across all types.</p>
<p>Instead, sort operates on homogeneous containers. All the elements have to match in type, so that they can be mutually compared. They donâ€™t each need to have different implementations of the operations.</p>
<p>Nevertheless, sort is still polymorphic. A sorting algorithm is the same for integers or strings, but comparing integers is a completely different operation than comparing strings. The sorting algorithm needs a way of invoking an operation on its items â€“ the comparison operation â€“ differently for different types, while still having the same overall structure of code.</p>
<p>This can be done by injecting a comparison function, but many types have an intrinsic, default ordering, and sort should default to it. Thus, polymorphism â€“ but not an OOP-friendly variety.</p>
<p>See the contrivance Java goes through to define sort:</p>
<pre><pre class="playground"><code class="language-rust edition2021"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>static &lt;T extends Comparable&lt;? super T&gt;&gt; 
void sort(List&lt;T&gt; list)
<span class="boring">}</span></code></pre></pre>
<p>There is no simple trait that can require T to be comparable to other Ts, for T to be ordered. Instead, as far as the programming language is concerned, the idea that T is comparable to itself, rather than to any other random type, is only articulated as an accident to this method. Nothing is stopping someone from implementing the Comparable interface in an inconsistent way, like having Integer implement Comparable<String>.</p>
<p>Additionally, when it actually looks up the implementation of Comparable, it decides what implementation to use based on the first argument of any comparison, not based on the type. Normally, they will all be the same type, but theoretically, this list could be heterogeneous, as long as all the objects â€œextendâ€ T, and they could implement Comparable differently. The computer has to do extra work to indulge this possibility, even though it would certainly be a mistake.</p>
<p>As weâ€™re now drifting outside of the realm of semantics, and into the realm of performance, letâ€™s discuss the performance implementations of this fully.</p>
<p>The Java sort method, as we mentioned, requires every item in the collection to be a full object type, which means that instead of storing the values directly in the array, the values are stored in the heap, and references are stored in the array. This is unnecessary with a traits-based approach â€“ the values can live directly in the array.</p>
<p>This means that different arrays will have different element sizes, so this has to be handled by a trait as well. And it is: The size of the values is also parameterized via the Sized trait. The size does have to be consistent among all the items of the array, but this is enforceable because we can express that all the elements are actually the exact same type â€“ unlike Javaâ€™s List<T> which only expresses that theyâ€™re of type T or some subtype of T.</p>
<p>Rustâ€™s sort method could have been implemented by passing the size information (from the Sized trait) and the ordering function (from the Ord trait) at runtime as an integer value and a function pointer. This is how typeclasses work in Haskell, which was the inspiration for Rust traits. This would still be more efficient than the Java, as there would be a single ordering function, rather than a different indirect lookup for every left side of the comparison, allowing indirect branch prediction to work in the processor.</p>
<p>But Rust goes even further than that, and implements its traits instead via monomorphization. This is similar to C++ template instantiation, but semantically better constrained. The premise is that while sort is only one method semantically, in the outputted, compiled code, a different version of sort is outputted for every type T that it is called with.</p>
<p>C++ templates create infamously bad error messages and are difficult to reason about, because they are essentially macros, and awkward ones. Even Rust cannot create great error messages with its macro system. But also, writing them requires expertise, and means that the programmer is forgoing many of the benefits of the type system â€“ templates are often called, in my opinion rightly so, a form of compile time duck-typing. For these reasons, template programming in C++ is often considered more advanced (read as harder and less convenient rather than more powerful) than OOP-style polymorphism.</p>
<p>In Rust, however, traits provide an organized and more coherent way of accessing similar technology, getting the performance benefits of templates while still giving the structure of a solid type system.</p>
<h3 id="alternative-3-dynamic-trait-objects"><a class="header" href="#alternative-3-dynamic-trait-objects">Alternative #3: Dynamic Trait Objects</a></h3>
<p>Sometimes, however, you do need full run-time polymorphism. You have the opposite of the scenario with the enum: You have a closed set of operations that can be performed on a value, but what those operations actually do will change dynamically in a way that cannot be bounded ahead of time.</p>
<p>In such situations, Rust has you covered with the dyn keyword. Please donâ€™t overuse it, though. In almost all situations where Iâ€™ve thought it might be appropriate, static polymorphism combined with other design elements have worked out better.</p>
<p>Legitimate use cases for dyn tend to come up in situations involving inversion of control, where a framework library takes on a main loop, and the client code says how to handle various events. In network programming, the framework library says how to juggle all the sockets and register them with the operating system, but the application needs to say what to actually do with the data. In GUI programming, the framework code can say what widget was being clicked on, but very different things happen if that widget is a button versus a text box versus a custom widget you invented for this particular app.</p>
<p>Now, you donâ€™t strictly need run-time polymorphism for this. You could use closures (or even raw function pointers) instead, creating struct of closures (or function pointers) if multiple operations are called for â€“ which amounts to basically doing what dyn does the hard way by hand. For example, I fully expected tokio to use Rustâ€™s run-time polymorphism feature internally to handle this inversion of control in task scheduling. Instead, for what I imagine are performance reasons, tokio implements dyn by hand, even calling its struct of function pointers Vtable.</p>
<p>But dyn does all of this work for you, for your trait. The only requirement is that your trait be object-safe, and the list of requirements may seem familiar, especially when it comes to the requirements for an associated function (e.g. a method) to be â€œdispatchableâ€:</p>
<hr />
<ul>
<li>Not have any type parameters (although lifetime parameters are allowed),</li>
<li>Be a method that does not use Self except in the type of the receiver.</li>
<li>Have a receiver with one of the following types:
<ul>
<li>&amp;Self (i.e. &amp;self)</li>
<li>&amp;mut Self (i.e &amp;mut self)</li>
<li>Box<Self></li>
<li>Rc<Self></li>
<li>Arc<Self></li>
<li>Pin<P> where P is one of the types above</li>
</ul>
</li>
<li>Does not have a where Self: Sized bound (receiver type of Self (i.e. self) implies this).</li>
</ul>
<hr />
<p>That is to say, it can be polymorphic in exactly one parameter, and that parameter must be by reference â€“ more or less the exact requirements for methods to support run-time polymorphism in OOP.</p>
<p>This is of course because dyn uses almost exactly the same mechanism as OOP to implement run-time polymorphism: the â€œvtable.â€ Box<dyn Foo> really contains two pointers rather than one, one to the object in question, and the pointer to the â€œvtable,â€ the automatically-generated structure of function pointers for that type. The one-parameter requirement is because that is the parameter whose vtable is used to look up which concrete implementation of a method to call, and the indirection requirement is because the concrete type might be different sizes, with the size only known at run-time.</p>
<p>To be clear, these are limitations on one particular implementation strategy for run-time polymorphism. Alternative strategies exist that fully decouple the vtable from individual values of the type, as in Haskell.</p>
<p>There are still a few advantages of Rustâ€™s version of run-time polymorphism with traits as opposed to OOP-style interfaces.</p>
<p>Performance-wise, itâ€™s something done alongside a type, rather than intrinsic to the type. Normal values donâ€™t store a vtable, spreading the cost of this throughout the program, but rather, the vtables are only referenced when a dyn pointer is created. If you never create a dyn pointer to a value of a given type, that typeâ€™s vtable doesnâ€™t even have to be created. Certainly, you donâ€™t have 8 bytes of extra gunk in every allocation for all the vtable pointers! This also means thereâ€™s one fewer level of indirection.</p>
<p>Semantically, itâ€™s also a good thing that itâ€™s just one option among many, and that itâ€™s not the strongly preferred option that the entire programming language is trying to push you towards. Often, even usually, static polymorphism, enums, or even just good old-fashioned closures more accurately represent the problem at hand, and should be used instead.</p>
<p>Finally, the fact that run-time and static polymorphism in Rust both use traits makes it easier to transition from one system to another. If you find yourself using dyn for a trait, you donâ€™t have to use it everywhere that trait is used. You can use the mechanisms of static polymorphism (like type parameters and impl Trait) instead, freely mixing and matching with the same traits.</p>
<p>Unlike in C++, you donâ€™t have to learn two completely different sets of syntax for concepts vs parent classes, and vastly different semantics. Really, in Rust, dynamic polymorphism is just a special case of static polymorphism, and the only differences are the things that actually are different.</p>
<h2 id="logging"><a class="header" href="#logging">logging</a></h2>
<ul>
<li>230215 ZQ init.</li>
</ul>

                    <div id="giscus-container"></div>
                </main>

                <nav class="nav-wrapper" aria-label="Page navigation">
                    <!-- Mobile navigation buttons -->
                    <a rel="prev" href="../tip/oop-1-encapsulation.html" class="mobile-nav-chapters previous"
                        title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../log/index.html" class="mobile-nav-chapters next"
                        title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>

                    <div style="clear: both"></div>
                </nav>
            </div>
        </div>

        <nav class="nav-wide-wrapper" aria-label="Page navigation">
            <a rel="prev" href="../tip/oop-1-encapsulation.html" class="nav-chapters previous" title="Previous chapter"
                aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>

            <a rel="next" href="../log/index.html" class="nav-chapters next" title="Next chapter"
                aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
        </nav>

    </div>




    <script type="text/javascript">
        window.playground_copyable = true;
    </script>


    <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

    <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
    <script src="../book.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" charset="utf-8">
        var pagePath = "tip/oop-2-polymorphism.md"
    </script>


    <!-- Custom JS scripts -->

    <hr />

    <p style="text-align:center">

        <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="çŸ¥è¯†å…±äº«è®¸å¯åè®®"
                style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a>
        æœ¬ä½œå“é‡‡ç”¨<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">çŸ¥è¯†å…±äº«ç½²å-ç›¸åŒæ–¹å¼å…±äº« 4.0 å›½é™…è®¸å¯åè®®</a>è¿›è¡Œè®¸å¯;-)

    </p>
    <hr />

    <script src="https://utteranc.es/client.js" repo="zhrust/comments" issue-term="pathname" label="âœ¨ğŸ’¬âœ¨"
        theme="github-light" crossorigin="anonymous" async>
        </script>

</body>

</html>